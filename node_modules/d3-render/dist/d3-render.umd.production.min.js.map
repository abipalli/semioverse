{"version":3,"file":"d3-render.umd.production.min.js","sources":["../src/render.ts","../src/getNamespace.ts","../src/index.ts"],"sourcesContent":["import * as d3 from 'd3-selection';\nimport 'd3-transition';\n\nimport getNamespace from './getNamespace';\n\ntype ElementDatum = {\n  append: string;\n  children?: ElementDatum[];\n  duration?: number | Function | TransitionObject;\n  delay?: number | Function | TransitionObject;\n  ease?: Function | TransitionObject;\n  style?: ElementStyles;\n  call?: Function;\n  [key: string]: ElementValue;\n};\n\ntype ElementValue = number | string | Function | object;\n\ntype ElementStyles = {\n  [key: string]: number | string | Function | object;\n};\n\ntype TransitionState = 'start' | 'enter' | 'update' | 'exit';\n\n// TODO: Causes type errors on style and children\ntype TransitionObject = {\n  start?: number | string | Function;\n  update?: number | string | Function;\n  enter: number | string | Function;\n  exit?: number | string | Function;\n};\n\n// type Selector = string | Node;\n\n// TODO: Consider incorporating element types from:\n// https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/react/index.d.ts\n\n/**\n * Using D3, this function renders elements based on declarative `data`, effectively replacing `select`, `append`, `data`, `join`, `enter`, `exit`, `transition` and more.\n * @param selector\n * @param data\n */\nexport default function render(selector, data: ElementDatum[]) {\n  // Crude way to check if `selector` is a D3 selection\n  if (typeof selector === 'object' && selector._groups && selector._parents) {\n    return renderSelection(selector, data);\n  }\n\n  const selection = d3.select(selector);\n\n  return renderSelection(selection, data);\n}\n\n/**\n * Recursively renders elements based on `data`, which can be deeply nested with the `children` key.\n */\nexport function renderSelection(selection, data: ElementDatum[], level = 0) {\n  if (!Boolean(data)) {\n    return selection;\n  }\n\n  return (\n    selection\n      // Cool way to select immediate children. (Totally didn't know you could do this)\n      .selectAll((_, i, nodes) => {\n        return nodes[i].children;\n      })\n      .data(\n        // Ensure all data elements are okay\n        data.filter(d => Boolean(d)),\n        (d, i) => d?.key || i\n      )\n      .join(\n        enter => {\n          return enter\n            .append(d => {\n              // Yes you saw that right. Append element based on 'append' key in data.\n              // Makes this whole function incredibly flexible\n              const namespace = getNamespace(d.append);\n\n              if (namespace === 'html') {\n                return document.createElement(d.append);\n              }\n\n              // https://stackoverflow.com/questions/51857699/append-shapes-dynamically-in-d3\n              return document.createElementNS(\n                // @ts-ignore\n                d3.namespace(namespace).space,\n                d.append\n              );\n            })\n            .each(function(d) {\n              const element = d3.select(this);\n\n              // Hook into things like selection.call(xAxis)\n              if (typeof d.call === 'function') {\n                d.call(element);\n              }\n\n              // Add initial attributes. For now, initial and exit values are the same\n              element.call(selection => addAttributes(selection, d, 'start'));\n\n              // Add HTML\n              if (d.html) {\n                element.html(d.html);\n              }\n\n              // Add events to element eg. onClick\n              element.call(selection => addEvents(selection, d));\n\n              // Add enter transitions\n              element.call(selection => addTransition(selection, d, 'enter'));\n\n              // element.call(selection =>\n              //   addEvents(selection, d, 'onTransition')\n              // );\n\n              // Recursively run again, passing in each child in selection\n              renderSelection(element, d.children, level + 1);\n            });\n        },\n        update => {\n          return update.each(function(d) {\n            const element = d3.select(this);\n            element.call(selection => addTransition(selection, d, 'update'));\n\n            renderSelection(element, d.children, level + 1);\n          });\n        },\n        exit => {\n          // Important magic sauce to exit all descendent children\n          exit.selectAll('*').each(exitTransition);\n\n          // NOTE: This doesn't seem to work, but '*' above will do for now\n          // exit.each(function(d) {\n          //   renderSelection(d3.select(this), d, level + 1);\n          // });\n\n          return exit.each(exitTransition);\n        }\n      )\n  );\n}\n\n/**\n * Add attributes to element node\n * @param selection\n * @param datum\n * @param state\n */\nfunction addAttributes(\n  selection,\n  datum: ElementDatum,\n  state: TransitionState\n  // node = null\n) {\n  // Assume anything other than key, text etc are attributes\n  const {\n    append,\n    call,\n    key,\n    text,\n    html,\n    style,\n    children,\n    duration,\n    delay,\n    ease,\n    ...attributes\n  } = datum;\n\n  // Rather than hand coding every attribute, we loop over the attributes object\n  for (const key in attributes) {\n    const attributeValue = attributes[key];\n    const value = getValue(attributeValue, state);\n    const isEvent = key.indexOf('on') === 0;\n\n    // Skip any on* events, we'll handle them in addEvents\n    if (!isEvent) {\n      selection.attr(keyToAttribute(key), value);\n    }\n  }\n\n  if (datum.text) {\n    selection.text(datum.text);\n  }\n\n  if (datum.style) {\n    selection = addStyles(selection, datum.style, state);\n  }\n\n  return selection;\n}\n\n/**\n * Add event to selection element\n * @param selection\n * @param datum\n */\nfunction addEvents(selection, datum, onPrefix = 'on') {\n  // Loop throught all keys in datum\n  for (const key in datum) {\n    const isEvent = key.indexOf(onPrefix) === 0;\n\n    // Only allow keys with on*\n    if (isEvent) {\n      const callback = datum[key];\n\n      // Check that the value is a callback function\n      if (typeof callback === 'function') {\n        const eventName = key.replace(onPrefix, '').toLowerCase();\n\n        selection.on(eventName, function(e, d) {\n          return callback(e, d);\n        });\n      }\n    }\n  }\n\n  return selection;\n}\n\n/**\n * Adds inline styles to the element\n * @param selection\n * @param styles\n * @param state\n */\nfunction addStyles(selection, styles: ElementStyles, state: TransitionState) {\n  for (const key in styles) {\n    const styleValue = styles[key];\n    const value = getValue(styleValue, state);\n\n    selection.style(camelToKebab(key), value);\n  }\n\n  return selection;\n}\n\n/**\n * Add transition to element, animating to a particular `state` by updating\n * selection with `addAttributes`\n * @param selection\n * @param datum\n * @param state\n */\nfunction addTransition(\n  selection,\n  datum: ElementDatum,\n  state: TransitionState = 'enter'\n) {\n  const duration = getValue(datum.duration, state);\n\n  if (!Boolean(datum)) {\n    return selection;\n  }\n\n  const delay = getValue(datum.delay, state) || 0;\n  const ease = getValue(datum.ease, state);\n\n  let transition = selection\n    .transition()\n    .delay(delay)\n    .duration(duration);\n\n  if (typeof ease === 'function') {\n    transition = transition.ease(t => ease(t));\n  }\n\n  if (state === 'exit') {\n    transition = transition.remove();\n  }\n\n  return selection\n    .transition(transition)\n    .call(selection => addAttributes(selection, datum, state));\n}\n\nfunction exitTransition(d) {\n  d3.select(this).call(selection => addTransition(selection, d, 'exit'));\n}\n\n/**\n * Get value from ElementDatum key, process and pass to selection.attr(),\n * selection.transition() or selection.style()\n * Every value can have an optional exit/enter value\n * We just check if value is an object eg. { exit: 0, enter: 100 }\n * @param value\n * @param state\n */\nfunction getValue(value, state: TransitionState): number | string | Function {\n  if (typeof value === 'object') {\n    const newValue = value[state];\n\n    // Default to `exit` if `start` value not available\n    // Assume that element will start the same way it exits\n    if (state === 'start' && isEmpty(newValue)) {\n      return value['exit'];\n    }\n\n    // Default to `enter` if `update` value not available\n    if (state === 'update' && isEmpty(newValue)) {\n      return value['enter'];\n    }\n\n    return newValue;\n  }\n\n  return value;\n}\n\n/**\n * Convert camelCase to kebab-case for JavaScript to HTML/CSS interop\n * @param string\n */\nfunction camelToKebab(string: string): string {\n  return string.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase();\n}\n\n/**\n * Convert key to HTML attribute. Most keys will change from camel to kebab\n * case, except for certain SVG attributes.\n * @param string\n */\nfunction keyToAttribute(key: string): string {\n  if (\n    [\n      'allowReorder',\n      'attributeName',\n      'attributeType',\n      'autoReverse',\n      'baseFrequency',\n      'baseProfile',\n      'calcMode',\n      'clipPathUnits',\n      'contentScriptType',\n      'contentStyleType',\n      'diffuseConstant',\n      'edgeMode',\n      'externalResourceRequired',\n      'filterRes',\n      'filterUnits',\n      'glyphRef',\n      'gradientTransform',\n      'gradientUnits',\n      'kernelMatrix',\n      'kernelUnitLength',\n      'keyPoints',\n      'keySplines',\n      'keyTimes',\n      'lengthAdjust',\n      'limitingConeAngle',\n      'markerHeight',\n      'markerUnits',\n      'markerWidth',\n      'maskContentUnits',\n      'maskUnits',\n      'numOctaves',\n      'pathLength',\n      'patternContentUnits',\n      'patternTransform',\n      'patternUnits',\n      'pointsAtX',\n      'pointsAtY',\n      'pointsAtZ',\n      'preserveAlpha',\n      'preserveAspectRatio',\n      'primitiveUnits',\n      'referrerPolicy',\n      'refX',\n      'refY',\n      'repeatCount',\n      'repeatDur',\n      'requiredExtensions',\n      'requiredFeatures',\n      'specularConstant',\n      'specularExponent',\n      'spreadMethod',\n      'startOffset',\n      'stdDeviation',\n      'stitchTiles',\n      'surfaceScale',\n      'systemLanguage',\n      'tableValues',\n      'targetX',\n      'targetY',\n      'textLength',\n      'viewBox',\n      'xChannelSelector',\n      'yChannelSelector',\n      'zoomAndPan',\n    ].includes(key)\n  ) {\n    return key;\n  }\n\n  return camelToKebab(key);\n}\n\nfunction isEmpty(value) {\n  return value == null;\n}\n","/**\n * Work out what element type based on element name\n * Most commonly 'svg' or 'html'\n */\nfunction getNamespace(elementName) {\n  // SVG Element list from\n  // https://developer.mozilla.org/en-US/docs/Web/SVG/Element\n  if (\n    [\n      // 'a',\n      'animate',\n      'animateMotion',\n      'animateTransform',\n      'circle',\n      'clipPath',\n      'color-profile',\n      'defs',\n      'desc',\n      'discard',\n      'ellipse',\n      'feBlend',\n      'feColorMatrix',\n      'feComponentTransfer',\n      'feComposite',\n      'feConvolveMatrix',\n      'feDiffuseLighting',\n      'feDisplacementMap',\n      'feDistantLight',\n      'feDropShadow',\n      'feFlood',\n      'feFuncA',\n      'feFuncB',\n      'feFuncG',\n      'feFuncR',\n      'feGaussianBlur',\n      'feImage',\n      'feMerge',\n      'feMergeNode',\n      'feMorphology',\n      'feOffset',\n      'fePointLight',\n      'feSpecularLighting',\n      'feSpotLight',\n      'feTile',\n      'feTurbulence',\n      'filter',\n      'foreignObject',\n      'g',\n      'hatch',\n      'hatchpath',\n      'image',\n      'line',\n      'linearGradient',\n      'marker',\n      'mask',\n      'mesh',\n      'meshgradient',\n      'meshpatch',\n      'meshrow',\n      'metadata',\n      'mpath',\n      'path',\n      'pattern',\n      'polygon',\n      'polyline',\n      'radialGradient',\n      'rect',\n      // 'script',\n      'set',\n      'solidcolor',\n      'stop',\n      // 'style',\n      'svg',\n      'switch',\n      'symbol',\n      'text',\n      'textPath',\n      'title',\n      'tspan',\n      'unknown',\n      'use',\n      'view',\n    ].includes(elementName)\n  ) {\n    return 'svg';\n  }\n\n  return 'html';\n}\n\nexport default getNamespace;\n\n// Keep this HTML element list here in case it is better to search for\n// From https://developer.mozilla.org/en-US/docs/Web/HTML/Element\n// const htmlElements = [\n//   // Document Metadata\n//   'html',\n//   'base',\n//   'head',\n//   'link',\n//   'meta',\n//   'style',\n//   'title',\n//   // Sectioning Root\n//   'body',\n//   // Content Sectioning\n//   'address',\n//   'article',\n//   'aside',\n//   'footer',\n//   'header',\n//   'h1',\n//   'h2',\n//   'h3',\n//   'h4',\n//   'h5',\n//   'h6',\n//   'hgroup',\n//   'main',\n//   'nav',\n//   'section',\n//   // Text Content\n//   'blockquote',\n//   'dd',\n//   'div',\n//   'dl',\n//   'figcaption',\n//   'figure',\n//   'hr',\n//   'li',\n//   'main',\n//   'ol',\n//   'p',\n//   'pre',\n//   'ul',\n//   // Inline Text Semantics\n//   'a',\n//   'abbr',\n//   'b',\n//   'bdi',\n//   'bdo',\n//   'br',\n//   'cite',\n//   'code',\n//   'data',\n//   'dfn',\n//   'em',\n//   'i',\n//   'kbd',\n//   'mark',\n//   'q',\n//   'rb',\n//   'rp',\n//   'rt',\n//   'rtc',\n//   'ruby',\n//   's',\n//   'samp',\n//   'small',\n//   'span',\n//   'strong',\n//   'sub',\n//   'sup',\n//   'time',\n//   'u',\n//   'var',\n//   'wbr',\n//   // Image and Multimedia\n//   'area',\n//   'audio',\n//   'img',\n//   'map',\n//   'track',\n//   'video',\n//   'embed',\n//   'iframe',\n//   'object',\n//   'param',\n//   'picture',\n//   'source',\n//   // Scripting\n//   'canvas',\n//   'noscript',\n//   'script',\n//   // Demarcating Edits\n//   'del',\n//   'ins',\n//   // Table Content\n//   'caption',\n//   'col',\n//   'colgroup',\n//   'table',\n//   'tbody',\n//   'td',\n//   'tfoot',\n//   'th',\n//   'thead',\n//   'tr',\n//   // Forms\n//   'button',\n//   'datalist',\n//   'fieldset',\n//   'form',\n//   'input',\n//   'label',\n//   'legend',\n//   'meter',\n//   'optgroup',\n//   'option',\n//   'output',\n//   'progress',\n//   'select',\n//   'textarea',\n//   // Interactive Elements\n//   'details',\n//   'dialog',\n//   'menu',\n//   'summary',\n//   // Web Components\n//   'slot',\n//   'template',\n// ];\n","import { selection } from 'd3-selection';\nimport render, { renderSelection } from './render';\n\n// TODO: Attempt at chaining render\nfunction chainedRender(data) {\n  return render(this, data);\n}\n\nselection.prototype.render = chainedRender;\n\nexport default render;\nexport { renderSelection };\n"],"names":["render","selector","data","renderSelection","_groups","_parents","d3","selection","level","Boolean","selectAll","_","i","nodes","children","filter","d","key","join","enter","append","namespace","includes","document","createElement","createElementNS","space","each","element","this","call","addAttributes","html","datum","onPrefix","indexOf","callback","eventName","replace","toLowerCase","on","e","addEvents","addTransition","update","exit","exitTransition","state","attributes","value","getValue","attr","camelToKebab","text","style","styles","addStyles","duration","delay","ease","transition","t","remove","newValue","isEmpty","string","prototype"],"mappings":"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"}